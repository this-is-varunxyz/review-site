<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Faculty Review System</title>
    <style>
        /* Your existing CSS styles remain exactly the same */
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìö Faculty Review</h1>
            <p>Share your honest feedback to help fellow students</p>
        </div>

        <div class="form-container">
            <div id="facultyDetails" class="faculty-details" style="display: none;">
                <h3 id="facultyNameDisplay"></h3>
                <p id="facultyDepartment"></p>
                <p id="facultySubject"></p>
            </div>

            <div class="faculty-info">
                <div class="faculty-name">Faculty Name</div>
                <input type="text" id="facultyNameInput" class="faculty-input" placeholder="Enter faculty name..." required>
            </div>

            <div id="averageContainer" class="average-container" style="display: none;">
                <h3>üìä Faculty Averages</h3>
                <div class="average-grid">
                    <div class="average-item">
                        <div class="label">Teaching</div>
                        <div class="value" id="avgTeaching">-</div>
                        <div class="count" id="countTeaching">0 reviews</div>
                    </div>
                    <div class="average-item">
                        <div class="label">Evaluation</div>
                        <div class="value" id="avgEvaluation">-</div>
                        <div class="count" id="countEvaluation">0 reviews</div>
                    </div>
                    <div class="average-item">
                        <div class="label">Behaviour</div>
                        <div class="value" id="avgBehaviour">-</div>
                        <div class="count" id="countBehaviour">0 reviews</div>
                    </div>
                    <div class="average-item">
                        <div class="label">Internals</div>
                        <div class="value" id="avgInternals">-</div>
                        <div class="count" id="countInternals">0 reviews</div>
                    </div>
                    <div class="average-item">
                        <div class="label">Class Avg</div>
                        <div class="value" id="avgClassAverage">-</div>
                        <div class="count" id="countClassAverage">0 reviews</div>
                    </div>
                    <div class="average-item">
                        <div class="label">Overall</div>
                        <div class="value" id="avgOverall">-</div>
                        <div class="count" id="countOverall">0 reviews</div>
                    </div>
                </div>
            </div>

            <form id="reviewForm">
                <!-- Teaching Rating -->
                <div class="rating-group">
                    <label class="rating-label">üìñ Teaching</label>
                    <div class="rating-container" data-rating="teaching">
                        <span class="star" data-value="1">‚≠ê</span>
                        <span class="star" data-value="2">‚≠ê</span>
                        <span class="star" data-value="3">‚≠ê</span>
                        <span class="star" data-value="4">‚≠ê</span>
                        <span class="star" data-value="5">‚≠ê</span>
                    </div>
                </div>

                <!-- Evaluation Rating -->
                <div class="rating-group">
                    <label class="rating-label">üìù Evaluation</label>
                    <div class="rating-container" data-rating="evaluation">
                        <span class="star" data-value="1">‚≠ê</span>
                        <span class="star" data-value="2">‚≠ê</span>
                        <span class="star" data-value="3">‚≠ê</span>
                        <span class="star" data-value="4">‚≠ê</span>
                        <span class="star" data-value="5">‚≠ê</span>
                    </div>
                </div>

                <!-- Behaviour Rating -->
                <div class="rating-group">
                    <label class="rating-label">üòä Behaviour</label>
                    <div class="rating-container" data-rating="behaviour">
                        <span class="star" data-value="1">‚≠ê</span>
                        <span class="star" data-value="2">‚≠ê</span>
                        <span class="star" data-value="3">‚≠ê</span>
                        <span class="star" data-value="4">‚≠ê</span>
                        <span class="star" data-value="5">‚≠ê</span>
                    </div>
                </div>

                <!-- Internals Rating -->
                <div class="rating-group">
                    <label class="rating-label">üìä Internals</label>
                    <div class="rating-container" data-rating="internals">
                        <span class="star" data-value="1">‚≠ê</span>
                        <span class="star" data-value="2">‚≠ê</span>
                        <span class="star" data-value="3">‚≠ê</span>
                        <span class="star" data-value="4">‚≠ê</span>
                        <span class="star" data-value="5">‚≠ê</span>
                    </div>
                </div>

                <!-- Class Average Input -->
                <div class="class-average-input">
                    <label for="classAverage">üìà Your Class Average</label>
                    <input type="number" id="classAverage" min="0" max="100" step="0.1" placeholder="e.g. 85.5" required>
                    <div class="note">Enter your average percentage in this faculty's class</div>
                </div>

                <!-- Overall Rating -->
                <div class="rating-group">
                    <label class="rating-label">‚ú® Overall Rating</label>
                    <div class="rating-container" data-rating="overall">
                        <span class="star" data-value="1">‚≠ê</span>
                        <span class="star" data-value="2">‚≠ê</span>
                        <span class="star" data-value="3">‚≠ê</span>
                        <span class="star" data-value="4">‚≠ê</span>
                        <span class="star" data-value="5">‚≠ê</span>
                    </div>
                </div>

                <button type="submit" class="submit-btn" id="submitBtn">
                    Submit Review
                </button>
            </form>

            <div class="success-message" id="successMessage">
                <h3>üéâ Thank you for your feedback!</h3>
                <p>Your review has been submitted successfully.</p>
                <p id="successDetails"></p>
            </div>

            <div class="error-message" id="errorMessage">
                <h3>‚ùå Submission Failed</h3>
                <p id="errorDetails">Please try again or check your connection.</p>
            </div>
        </div>
    </div>

<script>
    // Rating system
    const ratings = { 
        teaching: 0, 
        evaluation: 0, 
        behaviour: 0,
        internals: 0,
        classAverage: 0,
        overall: 0
    };

    // Local storage key for tracking reviewed faculty
    const REVIEWED_FACULTY_KEY = 'reviewedFaculty';
    // Use local API base URL for development
    const API_BASE_URL = 'http://localhost:3001';

    // Disable right-click and F12
    document.addEventListener('contextmenu', function(e) {
        e.preventDefault();
    });
    
    document.addEventListener('keydown', function(e) {
        if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && e.key === 'I') || (e.ctrlKey && e.shiftKey && e.key === 'J') || (e.ctrlKey && e.key === 'U')) {
            e.preventDefault();
        }
    });

    // Make faculty name input read-only if it comes from URL
    document.addEventListener('DOMContentLoaded', async function() {
        const urlParams = new URLSearchParams(window.location.search);
        const facultyNameFromUrl = urlParams.get('faculty');
        const facultyInput = document.getElementById('facultyNameInput');
        
        if (facultyNameFromUrl) {
            try {
                const decodedName = decodeURIComponent(facultyNameFromUrl);
                facultyInput.value = decodedName;
                facultyInput.readOnly = true;
                facultyInput.style.backgroundColor = 'rgba(255, 255, 255, 0.05)';
                facultyInput.style.cursor = 'not-allowed';
                
                await loadFacultyDetails(decodedName);
                await loadFacultyAverages(decodedName);
            } catch (error) {
                console.error('Error loading faculty data:', error);
                showError('Failed to load faculty data');
            }
        }
        
        // Initialize all rating stars
        document.querySelectorAll('.rating-container').forEach(container => {
            const stars = container.querySelectorAll('.star');
            stars.forEach(star => {
                star.addEventListener('click', function() {
                    const value = parseInt(this.dataset.value);
                    const ratingType = container.dataset.rating;
                    ratings[ratingType] = value;
                    
                    // Update star appearance
                    stars.forEach((s, index) => {
                        if (index < value) {
                            s.classList.add('active');
                        } else {
                            s.classList.remove('active');
                        }
                    });
                });
            });
        });
    });

    // Load faculty details from API
    async function loadFacultyDetails(facultyName) {
        try {
            const response = await fetch(`${API_BASE_URL}/api/faculty/${encodeURIComponent(facultyName)}`);
            if (!response.ok) throw new Error('Faculty not found');
            
            const data = await response.json();
            if (data.success && data.data) {
                const facultyDetails = document.getElementById('facultyDetails');
                document.getElementById('facultyNameDisplay').textContent = data.data.name;
                document.getElementById('facultyDepartment').textContent = data.data.department || 'Department not specified';
                document.getElementById('facultySubject').textContent = data.data.subject || 'Subject not specified';
                facultyDetails.style.display = 'block';
                
                // Check if already reviewed
                if (checkReviewedStatus(data.data.name)) {
                    showError('You have already reviewed this faculty member');
                    document.getElementById('submitBtn').disabled = true;
                }
            }
        } catch (error) {
            console.error('Error loading faculty details:', error);
            document.getElementById('facultyDetails').style.display = 'none';
        }
    }

    // Load faculty averages from API
    async function loadFacultyAverages(facultyName) {
        try {
            const response = await fetch(`${API_BASE_URL}/api/faculty-averages?faculty=${encodeURIComponent(facultyName)}`);
            if (!response.ok) throw new Error('Failed to load averages');
            
            const data = await response.json();
            if (data.success && data.averages) {
                document.getElementById('avgTeaching').textContent = data.averages.teaching || '-';
                document.getElementById('avgEvaluation').textContent = data.averages.evaluation || '-';
                document.getElementById('avgBehaviour').textContent = data.averages.behaviour || '-';
                document.getElementById('avgInternals').textContent = data.averages.internals || '-';
                document.getElementById('avgClassAverage').textContent = data.averages.classAverage || '-';
                document.getElementById('avgOverall').textContent = data.averages.overall || '-';
                
                document.getElementById('countTeaching').textContent = `${data.averages.count} reviews`;
                document.getElementById('countEvaluation').textContent = `${data.averages.count} reviews`;
                document.getElementById('countBehaviour').textContent = `${data.averages.count} reviews`;
                document.getElementById('countInternals').textContent = `${data.averages.count} reviews`;
                document.getElementById('countClassAverage').textContent = `${data.averages.count} reviews`;
                document.getElementById('countOverall').textContent = `${data.averages.count} reviews`;
                
                document.getElementById('averageContainer').style.display = 'block';
            } else {
                document.getElementById('averageContainer').style.display = 'none';
            }
        } catch (error) {
            console.error('Error loading faculty averages:', error);
            document.getElementById('averageContainer').style.display = 'none';
        }
    }

    // Check if faculty was already reviewed
    function checkReviewedStatus(facultyName) {
        try {
            const reviewedFaculty = localStorage.getItem(REVIEWED_FACULTY_KEY);
            if (!reviewedFaculty) return false;
            
            const facultyList = JSON.parse(reviewedFaculty);
            if (!Array.isArray(facultyList)) return false;
            
            // Normalize name for comparison (remove extra spaces and convert to lowercase)
            const normalizedInput = facultyName.trim().toLowerCase();
            return facultyList.some(name => name.trim().toLowerCase() === normalizedInput);
        } catch (e) {
            return false;
        }
    }

    // Save faculty as reviewed
    function saveReviewedStatus(facultyName) {
        try {
            let reviewedFaculty = JSON.parse(localStorage.getItem(REVIEWED_FACULTY_KEY) || '[]');
            if (!Array.isArray(reviewedFaculty)) reviewedFaculty = [];
            
            // Normalize the name before saving
            const normalizedName = facultyName.trim();
            
            // Check if already exists (case-insensitive)
            const exists = reviewedFaculty.some(name => 
                name.trim().toLowerCase() === normalizedName.toLowerCase()
            );
            
            if (!exists) {
                reviewedFaculty.push(normalizedName);
                localStorage.setItem(REVIEWED_FACULTY_KEY, JSON.stringify(reviewedFaculty));
            }
        } catch (e) {
            console.error('Error saving reviewed status:', e);
        }
    }

    // Show error message
    function showError(message) {
        const errorMessage = document.getElementById('errorMessage');
        const errorDetails = document.getElementById('errorDetails');
        errorDetails.textContent = message;
        errorMessage.style.display = 'block';
        
        setTimeout(() => {
            errorMessage.style.display = 'none';
        }, 5000);
    }

    // Show success message
    function showSuccess(message, details = '') {
        const successMessage = document.getElementById('successMessage');
        const successDetails = document.getElementById('successDetails');
        successDetails.textContent = details;
        successMessage.style.display = 'block';
        
        setTimeout(() => {
            successMessage.style.display = 'none';
        }, 5000);
    }

    // Handle faculty name changes
    document.getElementById('facultyNameInput').addEventListener('change', async function() {
        const facultyName = this.value.trim();
        const urlParams = new URLSearchParams(window.location.search);
        const facultyNameFromUrl = urlParams.get('faculty');
        
        if (facultyNameFromUrl && this.value !== decodeURIComponent(facultyNameFromUrl)) {
            this.value = decodeURIComponent(facultyNameFromUrl);
            return;
        }
        
        if (facultyName) {
            await loadFacultyDetails(facultyName);
            await loadFacultyAverages(facultyName);
        } else {
            document.getElementById('averageContainer').style.display = 'none';
            document.getElementById('facultyDetails').style.display = 'none';
        }
    });

    // Handle form submission
    document.getElementById('reviewForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const submitBtn = document.getElementById('submitBtn');
        const facultyName = document.getElementById('facultyNameInput').value.trim();
        const classAverage = parseFloat(document.getElementById('classAverage').value);
        const urlParams = new URLSearchParams(window.location.search);
        const facultyNameFromUrl = urlParams.get('faculty');
        
        // Validate faculty name
        if (!facultyName) {
            showError('Please enter a faculty name');
            return;
        }

        // Verify faculty name hasn't been tampered with
        if (facultyNameFromUrl && facultyName !== decodeURIComponent(facultyNameFromUrl)) {
            showError('Faculty name cannot be modified');
            document.getElementById('facultyNameInput').value = decodeURIComponent(facultyNameFromUrl);
            return;
        }

        // Validate all ratings are provided
        for (const key in ratings) {
            if (ratings[key] === 0 && key !== 'classAverage') {
                showError('Please provide all ratings');
                return;
            }
        }

        // Validate class average
        if (isNaN(classAverage) || classAverage < 0 || classAverage > 100) {
            showError('Please enter a valid class average between 0 and 100');
            return;
        }

        // Check if already reviewed
        if (checkReviewedStatus(facultyName)) {
            showError('You have already reviewed this faculty member');
            return;
        }

        try {
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';
            
            // Prepare review data
            const reviewData = {
                name: facultyName,
                teaching: ratings.teaching,
                evaluation: ratings.evaluation,
                behaviour: ratings.behaviour,
                internals: ratings.internals,
                classAverage: classAverage,
                overall: ratings.overall
            };

            // Submit to API
            const response = await fetch(`${API_BASE_URL}/api/submit-review`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(reviewData)
            });

            const result = await response.json();
            
            if (!response.ok) {
                throw new Error(result.error || 'Failed to submit review');
            }

            // Success
            showSuccess('Review submitted successfully!', `Thank you for reviewing ${facultyName}`);
            saveReviewedStatus(facultyName);
            
            // Reset form but keep faculty name
            document.getElementById('reviewForm').reset();
            document.getElementById('facultyNameInput').value = facultyName;
            Object.keys(ratings).forEach(key => ratings[key] = 0);
            document.querySelectorAll('.star').forEach(star => star.classList.remove('active'));
            
            // Reload averages to show updated data
            await loadFacultyAverages(facultyName);
        } catch (error) {
            console.error('Submission error:', error);
            showError(error.message || 'Failed to submit review. Please try again.');
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Submit Review';
        }
    });
</script>
</body>
</html>